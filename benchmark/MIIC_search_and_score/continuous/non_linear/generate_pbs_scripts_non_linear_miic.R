library(readr)

# Parameters
node_counts <- c("20", "50", "150")
average_degrees <- c("3", "5")

# Output directory
output_dir <- "job_scripts/miic/continuous/non_linear"
script_path <- "/data/users/nlagrang/run_miic_search_score_non_linear.R"

dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

`%+%` <- function(a, b) paste0(a, b)

for (n_nodes in node_counts) {
  for (degree in average_degrees) {
    for (sample_sizes in list(c("100", "250", "500", "1000"), c("5000"), c("10000"), c("20000"))) {
      
      sample_str <- paste(sample_sizes, collapse = ",")
      sample_suffix <- if (length(sample_sizes) == 1) sample_sizes else "small"
      max_sample <- max(as.numeric(sample_sizes))
      int_nodes <- as.numeric(n_nodes)
      
      # Memory
      mem <- "4gb"
      
      # Walltime
      walltime <- "24:00:00"
      
      # CPU / threads
      ppn <- if (int_nodes == 150 && max_sample >= 10000) {
        4
      } else if (int_nodes == 150 || max_sample >= 10000) {
        2
      } else {
        1
      }
      
      script_name <- file.path(output_dir, paste0("N", n_nodes, "_", degree, "_", sample_suffix, "_array.sh"))
      job_name <- paste0("NL_N", n_nodes, "_", degree, "_", sample_suffix, "_array")
      
      script_content <- c(
        "# This script was auto-generated by generate_pbs_scripts_non_linear_miic.R",
        "#!/bin/bash",
        "#PBS -N " %+% job_name,
        "#PBS -l walltime=" %+% walltime,
        "#PBS -l mem=" %+% mem,
        "#PBS -l nodes=1:ppn=" %+% ppn,
        "#PBS -t 1-30",
        "#PBS -j oe",
        "#PBS -q batch",
        "",
        "source ~/.bashrc",
        "",
        paste0("N_NODES=", n_nodes),
        paste0("AVG_DEGREE=", degree),
        paste0("SAMPLE_SIZES=\"", sample_str, "\""),
        paste0("N_THREADS=", ppn),
        "REPLICA_ID=${PBS_ARRAYID}",
        "",
        "echo \"Launching replicate $REPLICA_ID with $N_NODES nodes, degree $AVG_DEGREE, samples $SAMPLE_SIZES, threads $N_THREADS\"",
        "",
        paste("Rscript", script_path, "\\"),
        "  \"$N_NODES\" \"$AVG_DEGREE\" \"$SAMPLE_SIZES\" \"$N_THREADS\" \"$REPLICA_ID\""
      )
      
      write_lines(script_content, file = script_name)
    }
  }
}
